<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>OBURUS â€“ Personalized Recommender (Debug)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }
    input, button, select {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      background-color: #f9f9f9;
    }
    .debug-info {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .score-breakdown {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<h2>ğŸ½ï¸ OBURUS â€“ Personalized Restaurant Recommender (Debug Mode)</h2>

<label>Latitude</label>
<input id="lat" value="41.04" type="number" step="0.0001">

<label>Longitude</label>
<input id="lng" value="29.02" type="number" step="0.0001">

<label>Ne istiyorsun? (Ã¶rn: coffee,dessert,kebap) - Opsiyonel</label>
<input id="prefs" placeholder="coffee,dessert">

<label>YarÄ±Ã§ap (km)</label>
<input id="radius" value="5" type="number" step="0.1">

<label for="user-select">Bir KullanÄ±cÄ± SeÃ§</label>
<select id="user-select">
  <option value="">YÃ¼kleniyor...</option>
</select>

<button onclick="fetchRecommendations()">Ã–nerileri Getir</button>

<hr>

<div id="debug-info"></div>
<div id="results"></div>

<script>
  // --- Debug Logger ---
  function logDebug(message, data = null) {
    const debugDiv = document.getElementById("debug-info");
    const timestamp = new Date().toLocaleTimeString();
    let logEntry = `[${timestamp}] ${message}`;
    
    if (data) {
      logEntry += `\n${JSON.stringify(data, null, 2)}`;
    }
    
    const pre = document.createElement("pre");
    pre.className = "debug-info";
    pre.textContent = logEntry;
    debugDiv.appendChild(pre);
    
    console.log(message, data);
  }

  function showError(message) {
    const debugDiv = document.getElementById("debug-info");
    const errorDiv = document.createElement("div");
    errorDiv.className = "error";
    errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
    debugDiv.appendChild(errorDiv);
  }

  function showSuccess(message) {
    const debugDiv = document.getElementById("debug-info");
    const successDiv = document.createElement("div");
    successDiv.className = "success";
    successDiv.innerHTML = `<strong>Success:</strong> ${message}`;
    debugDiv.appendChild(successDiv);
  }

  // --- Result Renderer ---
  function renderResults(data, container) {
    container.innerHTML = "";

    logDebug("Rendering results", {
      algo: data.algo,
      count: data.count,
      itemsLength: data.items ? data.items.length : 0,
      user_id: data.user_id,
      user_historical_prefs: data.user_historical_prefs,
      query_prefs: data.query_prefs,
      expanded_prefs: data.expanded_prefs
    });

    if (!data.items || data.items.length === 0) {
      container.innerHTML = `
        <div class="error">
          <p><strong>SonuÃ§ bulunamadÄ±.</strong></p>
          <p>OlasÄ± nedenler:</p>
          <ul>
            <li>SeÃ§ilen yarÄ±Ã§ap iÃ§inde eÅŸleÅŸen restoran yok</li>
            <li>Tercihlerinizle eÅŸleÅŸen kategori yok</li>
            <li>Neo4j veritabanÄ±nda veri yok</li>
            <li>KullanÄ±cÄ±nÄ±n geÃ§miÅŸ tercihleri yok</li>
          </ul>
          <p><strong>Ã–neriler:</strong></p>
          <ul>
            <li>YarÄ±Ã§apÄ± artÄ±rÄ±n (Ã¶rn: 10 km)</li>
            <li>Tercihleri boÅŸ bÄ±rakÄ±n (tÃ¼m kategoriler)</li>
            <li>FarklÄ± bir kullanÄ±cÄ± seÃ§in</li>
          </ul>
        </div>
      `;
      return;
    }

    showSuccess(`${data.items.length} sonuÃ§ bulundu!`);

    data.items.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "card";
      const matchedText = item.matched_categories && item.matched_categories.length > 0
        ? `â¤ï¸ Matched: ${item.matched_categories.join(", ")}`
        : 'âš ï¸ No category match (general ranking)';

      const sentimentEmoji = item.sentiment_label === "Positive" ? "ğŸ˜Š" : 
                             item.sentiment_label === "Negative" ? "ğŸ˜" : "ğŸ˜";

      let scoreBreakdown = "";
      if (item.score_breakdown) {
        scoreBreakdown = `
          <div class="score-breakdown">
            <strong>Score Breakdown:</strong><br>
            ${Object.entries(item.score_breakdown)
              .map(([key, value]) => `${key}: ${value}`)
              .join('<br>')}
          </div>
        `;
      }

      div.innerHTML = `
        <strong>#${index + 1}: ${item.name}</strong><br>
        â­ Score: <strong>${item.score.toFixed(4)}</strong><br>
        ğŸ“ ${item.km.toFixed(2)} km away<br>
        ğŸ´ Categories: ${item.categories || 'N/A'}<br>
        ğŸ’° Price Range: ${"$".repeat(item.price_range || 1)}<br>
        â­ Rating: ${item.rating_avg ? item.rating_avg.toFixed(1) : 'N/A'} (${item.rating_count || 0} reviews)<br>
        ${sentimentEmoji} Sentiment: ${item.sentiment_label || 'N/A'} (${item.sentiment_score ? item.sentiment_score.toFixed(2) : 'N/A'})<br>
        ${matchedText}
        ${scoreBreakdown}
      `;
      container.appendChild(div);
    });
  }

  // --- Unified Recommendation Search ---
  async function fetchRecommendations() {
    const lat = document.getElementById("lat").value;
    const lng = document.getElementById("lng").value;
    const prefs = document.getElementById("prefs").value.trim();
    const radius = document.getElementById("radius").value;
    const userId = document.getElementById("user-select").value;
    const resultsContainer = document.getElementById("results");
    const debugContainer = document.getElementById("debug-info");
    
    // Clear previous results
    resultsContainer.innerHTML = "";
    debugContainer.innerHTML = "";

    if (!lat || !lng) {
      showError("LÃ¼tfen latitude ve longitude deÄŸerlerini girin!");
      return;
    }

    let url;
    if (userId) {
      // Personalized recommendations
      url = `/users/${userId}/recommendations?lat=${lat}&lng=${lng}&radius_km=${radius}`;
      if (prefs) {
        url += `&prefs=${encodeURIComponent(prefs)}`;
      }
      logDebug("Fetching PERSONALIZED recommendations", { userId, lat, lng, radius, prefs });
    } else {
      // Generic recommendations
      if (!prefs) {
        showError("KullanÄ±cÄ± seÃ§mediniz. LÃ¼tfen tercih girin veya bir kullanÄ±cÄ± seÃ§in!");
        return;
      }
      url = `/rank?lat=${lat}&lng=${lng}&prefs=${encodeURIComponent(prefs)}&radius_km=${radius}`;
      logDebug("Fetching GENERIC recommendations", { lat, lng, radius, prefs });
    }

    logDebug("Request URL", url);
    resultsContainer.innerHTML = "<p>â³ Loading recommendations...</p>";

    try {
      const startTime = Date.now();
      const res = await fetch(url);
      const elapsed = Date.now() - startTime;
      
      logDebug(`Response received in ${elapsed}ms`, {
        status: res.status,
        statusText: res.statusText,
        ok: res.ok
      });

      if (!res.ok) {
        const errorText = await res.text();
        showError(`HTTP ${res.status}: ${res.statusText}<br>${errorText}`);
        resultsContainer.innerHTML = "";
        return;
      }

      const data = await res.json();
      logDebug("Response data", data);
      
      renderResults(data, resultsContainer);
    } catch (error) {
      showError(`Network error: ${error.message}`);
      logDebug("Fetch error", error);
      resultsContainer.innerHTML = "";
    }
  }

  // --- Populate Users on Load ---
  async function populateUsers() {
    const select = document.getElementById('user-select');
    
    try {
      logDebug("Fetching users list...");
      const res = await fetch('/users');
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const users = await res.json();
      logDebug(`Loaded ${users.length} users`, users);

      select.innerHTML = "";

      // Add default "Select User" option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- KullanÄ±cÄ± SeÃ§in (Opsiyonel) --';
      select.appendChild(defaultOption);

      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user_id; 
        option.textContent = `${user.name} (ID: ${user.user_id})`;
        select.appendChild(option);
      });

      // Auto-select the first real user if available
      if (users.length > 0) {
        select.value = users[0].user_id;
        showSuccess(`${users.length} kullanÄ±cÄ± yÃ¼klendi. Ä°lk kullanÄ±cÄ± otomatik seÃ§ildi.`);
      }
    } catch (error) {
      showError(`Failed to load users: ${error.message}`);
      select.innerHTML = `<option value="">Could not load users</option>`;
      logDebug("Error loading users", error);
    }
  }

  // --- Test Endpoints ---
  async function testEndpoints() {
    logDebug("Testing endpoints...");
    
    try {
      // Test health
      const health = await fetch('/health');
      const healthData = await health.json();
      logDebug("Health check", healthData);
      
      // Test users
      const users = await fetch('/users');
      const usersData = await users.json();
      logDebug("Users endpoint", { count: usersData.length });
      
      showSuccess("All endpoints are responding!");
    } catch (error) {
      showError(`Endpoint test failed: ${error.message}`);
    }
  }

  window.onload = async () => {
    await populateUsers();
    // Uncomment to auto-test endpoints on load
    // await testEndpoints();
  };
</script>

</body>
</html>