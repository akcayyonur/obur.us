<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBURUS – Personalized Recommender</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .header-bg {
      background: rgb(70,165,211);
      height: 60px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .gradient-bg {
      background: rgb(70,165,211);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    #map {
      height: calc(100vh - 60px);
      width: 100%;
      margin-top: 60px;
    }
    .sidebar {
      position: fixed;
      right: 0;
      top: 60px;
      height: calc(100vh - 60px);
      width: 450px;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      z-index: 100;
    }
    .filter-panel {
      position: fixed;
      left: 20px;
      top: 80px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      width: 320px;
      z-index: 100;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
    .mapboxgl-popup-content {
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .marker {
      background-size: cover;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .user-marker {
      background-color: rgb(70,139,139);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(70,139,139,0.5);
    }
    .result-item {
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    .result-item:hover {
      border-left-color: rgb(70,139,139);
      background-color: rgba(70,139,139,0.05);
    }
    .result-item.active {
      border-left-color: rgb(70,139,139);
      background-color: rgba(70,139,139,0.1);
    }
  </style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<div class="header-bg flex items-center px-6">
  <!-- Logo space (left side) -->
  <div class="w-12 h-12 mr-3">
    <img src="/logo.png" alt="OBURUS Logo" class="w-full h-full object-contain">
  </div>

  <!-- Project name -->
  <h1 class="text-2xl font-bold text-white">OBURUS</h1>

  <!-- User login form (right side) -->
  <div class="ml-auto flex items-center gap-3">
    <div id="user-info-display" class="hidden text-sm text-white bg-white bg-opacity-20 px-4 py-2 rounded-lg">
      <span id="logged-user-name"></span>
    </div>
    <div id="login-form" class="flex items-center gap-2">
      <input
        id="user-name-input"
        type="text"
        placeholder="Kullanıcı adı (örn: Zehra Kara)"
        class="px-3 py-2 rounded-lg text-sm w-64 focus:ring-2 focus:ring-white focus:outline-none"
      >
      <button
        onclick="loginUser()"
        class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-opacity-90 transition"
      >
        Giriş
      </button>
    </div>
    <button
      id="logout-btn"
      onclick="logoutUser()"
      class="hidden bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg text-sm transition"
    >
      Çıkış
    </button>
  </div>
</div>

<!-- Map Container -->
<div id='map'></div>

<!-- Filter Panel -->
<div class="filter-panel">
  <!-- Location Info -->
  <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
    <div class="flex items-center text-blue-700 mb-1">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span class="font-medium">Harita üzerinden konum seçin</span>
    </div>
    <div id="location-display" class="text-xs text-gray-600 mt-1">
      Lat: <span id="display-lat">41.04</span>, Lng: <span id="display-lng">29.02</span>
    </div>
  </div>

  <!-- Preferences -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Tercihler
    </label>
    <input id="prefs" type="text" placeholder="coffee, dessert, turkish" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm">
    <p class="text-xs text-gray-500 mt-1">Virgülle ayırın</p>
  </div>

  <!-- Radius -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Yarıçap: <span id="radius-value" class="font-semibold text-teal-700">5</span> km
    </label>
    <input id="radius" type="range" min="1" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" style="accent-color: rgb(70,139,139);" oninput="document.getElementById('radius-value').textContent = this.value">
  </div>

  <!-- Search Button -->
  <button onclick="fetchRecommendations()" class="w-full gradient-bg text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition shadow-md text-sm">
    <span class="flex items-center justify-center">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      Önerileri Getir
    </span>
  </button>
</div>

<!-- Sidebar Results -->
<div class="sidebar">
  <div class="p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Sonuçlar</h2>
    <div id="results">
      <div class="text-center py-12">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <p class="text-gray-500">Arama yapın</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Global state
  let map;
  let userMarker;
  let currentLat = 41.04;
  let currentLng = 29.02;
  let currentUser = null;
  let allUsers = [];
  let restaurantMarkers = [];
  let currentResults = [];
  let expandedReviewId = null; // Track which restaurant's reviews are expanded

  // Initialize map with token from API
  async function initMap() {
    try {
      // Fetch Mapbox token from API
      const configRes = await fetch('/config');
      const config = await configRes.json();
      mapboxgl.accessToken = config.mapbox_token;

      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [currentLng, currentLat],
        zoom: 13
      });
    } catch (error) {
      console.error('Failed to initialize map:', error);
      alert('Harita yüklenemedi. Lütfen Mapbox token\'ınızı kontrol edin.');
      return;
    }

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());

    // Add user location marker
    updateUserMarker(currentLat, currentLng);

    // Right click on map to select location
    map.on('contextmenu', (e) => {
      e.preventDefault(); // Prevent browser context menu
      currentLat = e.lngLat.lat;
      currentLng = e.lngLat.lng;
      updateUserMarker(currentLat, currentLng);
      updateLocationDisplay();
    });

    // Try to get user's current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        currentLat = position.coords.latitude;
        currentLng = position.coords.longitude;
        map.setCenter([currentLng, currentLat]);
        updateUserMarker(currentLat, currentLng);
        updateLocationDisplay();
      });
    }
  }

  // Update user marker
  function updateUserMarker(lat, lng) {
    if (userMarker) {
      userMarker.setLngLat([lng, lat]);
    } else {
      const el = document.createElement('div');
      el.className = 'user-marker';
      userMarker = new mapboxgl.Marker(el)
        .setLngLat([lng, lat])
        .addTo(map);
    }
  }

  // Update location display
  function updateLocationDisplay() {
    document.getElementById('display-lat').textContent = currentLat.toFixed(4);
    document.getElementById('display-lng').textContent = currentLng.toFixed(4);
  }

  // Clear restaurant markers
  function clearRestaurantMarkers() {
    restaurantMarkers.forEach(marker => marker.remove());
    restaurantMarkers = [];
  }

  // Add restaurant marker
  function addRestaurantMarker(item, index) {
    const el = document.createElement('div');
    el.className = 'marker';
    el.style.backgroundColor = getMarkerColor(item.score);

    const popup = new mapboxgl.Popup({ offset: 25 })
      .setHTML(`
        <div class="text-sm">
          <div class="font-bold text-gray-800 mb-1">${item.name}</div>
          <div class="text-xs text-gray-600 mb-2">${item.km.toFixed(2)} km uzaklıkta</div>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500">Eşleşme:</span>
            <span class="font-bold text-teal-700">${Math.min(100, (item.score * 100)).toFixed(0)}%</span>
          </div>
          ${item.matched_categories && item.matched_categories.length > 0 ? `
            <div class="mt-2 flex flex-wrap gap-1">
              ${item.matched_categories.map(cat =>
                `<span class="inline-block bg-pink-100 text-pink-700 px-2 py-0.5 rounded text-xs">${cat}</span>`
              ).join('')}
            </div>
          ` : ''}
        </div>
      `);

    const marker = new mapboxgl.Marker(el)
      .setLngLat([item.lng, item.lat])
      .setPopup(popup)
      .addTo(map);

    // Highlight result and show reviews on marker click
    el.addEventListener('click', () => {
      highlightResult(index);
      toggleReviews(item.id);
    });

    restaurantMarkers.push(marker);
  }

  // Get marker color based on score
  function getMarkerColor(score) {
    if (score >= 0.7) return '#10b981'; // green
    if (score >= 0.4) return '#f59e0b'; // yellow
    return '#6b7280'; // gray
  }

  // Highlight result
  function highlightResult(index) {
    document.querySelectorAll('.result-item').forEach((el, i) => {
      if (i === index) {
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        el.classList.remove('active');
      }
    });
  }

  // Toggle reviews for a restaurant
  function toggleReviews(restaurantId, event) {
    // Prevent event bubbling if called from click handler
    if (event) {
      event.stopPropagation();
    }

    const reviewsElement = document.getElementById(`reviews-${restaurantId}`);
    if (!reviewsElement) return;

    // If this restaurant's reviews are already expanded, collapse them
    if (expandedReviewId === restaurantId) {
      reviewsElement.classList.add('hidden');
      expandedReviewId = null;
    } else {
      // Collapse previously expanded reviews
      if (expandedReviewId) {
        const prevReviews = document.getElementById(`reviews-${expandedReviewId}`);
        if (prevReviews) {
          prevReviews.classList.add('hidden');
        }
      }

      // Expand new reviews
      reviewsElement.classList.remove('hidden');
      expandedReviewId = restaurantId;

      // Scroll to the restaurant card
      reviewsElement.closest('.result-item').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  // Fly to location on map
  function flyToLocation(lat, lng, index) {
    map.flyTo({
      center: [lng, lat],
      zoom: 15,
      essential: true
    });

    // Open the marker popup
    if (restaurantMarkers[index]) {
      restaurantMarkers[index].togglePopup();
    }

    highlightResult(index);
  }

  // Render results
  function renderResults(data) {
    const container = document.getElementById('results');
    container.innerHTML = '';

    if (!data.items || data.items.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12">
          <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-gray-500">Sonuç bulunamadı</p>
        </div>
      `;
      return;
    }

    currentResults = data.items;

    // Clear old markers
    clearRestaurantMarkers();

    // Header
    const header = document.createElement('div');
    header.className = 'mb-4 pb-3 border-b';
    header.innerHTML = `
      <div class="flex items-center justify-between">
        <span class="text-sm font-semibold text-gray-700">${data.items.length} Sonuç</span>
        <span class="text-xs text-gray-500">En İyi Eşleşmeler</span>
      </div>
    `;
    container.appendChild(header);

    // Results
    data.items.forEach((item, index) => {
      // Add marker to map
      addRestaurantMarker(item, index);

      // Create result card
      const div = document.createElement('div');
      div.className = 'result-item p-4 mb-3 bg-white rounded-lg shadow-sm hover:shadow-md transition';

      const matchedBadges = item.matched_categories && item.matched_categories.length > 0
        ? item.matched_categories.map(cat =>
            `<span class="inline-block bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full text-xs">${cat}</span>`
          ).join(' ')
        : '';

      const scoreColor = item.score >= 0.7 ? 'text-green-600' : item.score >= 0.4 ? 'text-yellow-600' : 'text-gray-600';

      div.innerHTML = `
        <div class="cursor-pointer" onclick="toggleReviews(${item.id}, event)">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-gray-800 text-sm flex-1">${item.name}</h3>
            <span class="text-lg font-bold ${scoreColor} ml-2">${Math.min(100, (item.score * 100)).toFixed(0)}%</span>
          </div>
          ${matchedBadges ? `<div class="flex flex-wrap gap-1 mb-2">${matchedBadges}</div>` : ''}
          <div class="flex items-center text-xs text-gray-600 mb-2">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            </svg>
            <span>${item.km.toFixed(2)} km</span>
            ${item.rating_avg ? `
              <span class="ml-3">★ ${item.rating_avg.toFixed(1)}</span>
            ` : ''}
          </div>
          <div class="text-xs text-gray-500">
            ${item.categories ? item.categories.split(',').slice(0, 3).join(', ') : ''}
          </div>
        </div>
        <div id="reviews-${item.id}" class="reviews-container hidden mt-3 pt-3 border-t border-gray-200">
          <div class="text-xs font-semibold text-gray-700 mb-2">Yorumlar:</div>
          <div class="text-xs text-gray-600 space-y-2 max-h-60 overflow-y-auto">
            ${item.reviews_text ?
              item.reviews_text.split(' ||| ').map(review =>
                `<div class="bg-gray-50 p-2 rounded">${review}</div>`
              ).join('')
              : '<div class="text-gray-400 italic">Yorum bulunmamaktadır</div>'}
          </div>
        </div>
      `;

      // Store reference for later use
      div.dataset.restaurantId = item.id;
      div.dataset.lat = item.lat;
      div.dataset.lng = item.lng;
      div.dataset.index = index;

      container.appendChild(div);
    });

    // Fit map to show all markers
    if (data.items.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      bounds.extend([currentLng, currentLat]); // Include user location
      data.items.forEach(item => bounds.extend([item.lng, item.lat]));
      map.fitBounds(bounds, { padding: { top: 50, bottom: 50, left: 400, right: 500 } });
    }
  }

  // Fetch recommendations
  async function fetchRecommendations() {
    if (!currentUser) {
      alert('Lütfen önce giriş yapın');
      return;
    }

    const prefs = document.getElementById('prefs').value;
    const radius = document.getElementById('radius').value;
    const resultsContainer = document.getElementById('results');

    // Loading state
    resultsContainer.innerHTML = `
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 mb-4" style="border-color: rgb(70,139,139);"></div>
        <p class="text-gray-600">Yükleniyor...</p>
      </div>
    `;

    let url = `/users/${currentUser.user_id}/recommendations?lat=${currentLat}&lng=${currentLng}&radius_km=${radius}`;
    if (prefs) {
      url += `&prefs=${prefs}`;
    }

    try {
      const res = await fetch(url);
      const data = await res.json();
      renderResults(data);
    } catch (error) {
      resultsContainer.innerHTML = `
        <div class="text-center py-12 text-red-600">
          <p class="font-semibold mb-2">Hata oluştu</p>
          <p class="text-sm">${error.message}</p>
        </div>
      `;
    }
  }

  // Login user by name
  async function loginUser() {
    const userName = document.getElementById('user-name-input').value.trim();

    if (!userName) {
      alert('Lütfen kullanıcı adı giriniz');
      return;
    }

    try {
      // Fetch all users from backend
      const res = await fetch('/users');
      allUsers = await res.json();

      // Find user by name (case-insensitive)
      currentUser = allUsers.find(u =>
        u.name.toLowerCase() === userName.toLowerCase()
      );

      if (currentUser) {
        // Login successful
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('user-info-display').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('logged-user-name').textContent = currentUser.name;

        // Clear input
        document.getElementById('user-name-input').value = '';
      } else {
        alert('Kullanıcı bulunamadı. Lütfen kullanıcı adınızı kontrol edin.\nÖrnek: Zehra Kara');
      }
    } catch (error) {
      console.error('Login failed:', error);
      alert('Giriş yapılamadı. Lütfen tekrar deneyin.');
    }
  }

  // Logout user
  function logoutUser() {
    currentUser = null;
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('user-info-display').classList.add('hidden');
    document.getElementById('logout-btn').classList.add('hidden');
    document.getElementById('logged-user-name').textContent = '';
  }

  // Allow Enter key to login
  document.addEventListener('DOMContentLoaded', () => {
    const userNameInput = document.getElementById('user-name-input');

    userNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loginUser();
      }
    });
  });

  // Initialize
  window.onload = () => {
    initMap();
  };
</script>

</body>
</html>