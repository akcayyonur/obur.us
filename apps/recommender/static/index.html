<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>OBURUS ‚Äì Personalized Recommender</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
    }
    input, button {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
    }
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<h2>üçΩÔ∏è OBURUS ‚Äì Personalized Restaurant Recommender</h2>

<label>Latitude</label>
<input id="lat" value="41.04">

<label>Longitude</label>
<input id="lng" value="29.02">

<label>Ne istiyorsun? (√∂rn: coffee,dessert)</label>
<input id="prefs" placeholder="coffee,dessert">

<label>Yarƒ±√ßap (km)</label>
<input id="radius" value="5">

<label for="user-select">Bir Kullanƒ±cƒ± Se√ß</label>
<select id="user-select" style="width: 100%; padding: 8px; margin: 6px 0;"></select>

<button onclick="fetchRecommendations()">√ñnerileri Getir</button>

<hr>


<div id="results"></div>

<script>
  // --- Reusable Result Renderer ---
  function renderResults(data, container) {
    container.innerHTML = ""; // Clear previous results

    if (!data.items || data.items.length === 0) {
      container.innerHTML = "<p>Sonu√ß bulunamadƒ±.</p>";
      return;
    }

    data.items.forEach(item => {
      const div = document.createElement("div");
      div.className = "card";
      const matchedText = item.matched_categories && item.matched_categories.length > 0
        ? `‚ù§Ô∏è Matched: ${item.matched_categories.join(", ")}`
        : '';

      div.innerHTML = `
        <strong>${item.name}</strong><br>
        ‚≠ê Score: ${item.score}<br>
        üìç ${item.km.toFixed(2)} km<br>
        üç¥ Categories: ${item.categories || 'N/A'}<br>
        ${matchedText}
      `;
      container.appendChild(div);
    });
  }

  // --- Unified Recommendation Search ---
  async function fetchRecommendations() {
    const lat = document.getElementById("lat").value;
    const lng = document.getElementById("lng").value;
    const prefs = document.getElementById("prefs").value;
    const radius = document.getElementById("radius").value;
    const userId = document.getElementById("user-select").value; // Get selected user ID
    const resultsContainer = document.getElementById("results");
    resultsContainer.innerHTML = "<p>Loading recommendations...</p>";

    let url;
    if (userId) {
      // Personalized recommendations
      url = `/users/${userId}/recommendations?lat=${lat}&lng=${lng}&radius_km=${radius}`;
      if (prefs) {
        url += `&prefs=${prefs}`;
      }
    } else {
      // Generic recommendations
      url = `/rank?lat=${lat}&lng=${lng}&prefs=${prefs}&radius_km=${radius}`;
    }

    try {
      const res = await fetch(url);
      const data = await res.json();
      renderResults(data, resultsContainer);
    } catch (error) {
      resultsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
    }
  }

  // --- Populate Users on Load ---
  async function populateUsers() {
    try {
      const res = await fetch('/users');
      const users = await res.json();
      const select = document.getElementById('user-select');

      // Add default "Select User" option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Kullanƒ±cƒ± Se√ßin';
      select.appendChild(defaultOption);

      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user_id;
        option.textContent = user.name;
        select.appendChild(option);
      });
    } catch (error) {
      const select = document.getElementById('user-select');
      select.innerHTML = `<option value="">Could not load users</option>`;
      console.error("Failed to populate users:", error);
    }
  }

  window.onload = populateUsers;
</script>

</body>
</html>
